{% extends "base.html" %}
{% load i18n %}
{% block title %}{{profileuser}}{% endblock %}

{% block header %}
{{profileuser}}
{% endblock %}

{% block pullright %}

{% endblock %}

{% block content %}
<div class="row">
{% if perms.users.read_user %}
  <ul class="nav nav-tabs" id="myTab">
  <li class="active"><a href="#about" data-toggle="tab" data-tab="about">About</a></li>
  <li><a href="#devices" data-toggle="tab" data-tab="devices">Devices</a></li>
  <li><a href="#edits" data-toggle="tab" data-tab="edits">Edits</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="about">
  {% if profileuser.avatar %}
  <div class="col-sm-12 col-md-2" style="margin-top:20px">
    <a href="#" class="thumbnail">
      <img src="{{profileuser.avatar.url}}" alt="Avatar">
    </a>
  </div>
  {% endif %}
  <div class="col-sm-12 col-md-6" style="margin-top:20px">
    <table class="table table-bordered">
      <tr>
        <td>{% trans "Name" %}</td><td>{{profileuser.first_name}} {{profileuser.last_name}}</td>
      </tr>
      <tr>
        <td>{% trans "Groups" %}</td>
        <td>
          {% for group in profileuser.groups.all %}
          {{group.name}}<br>
          {% endfor %}
        </td>
      </tr>
      <tr>
        <td>{% trans "Last Login" %}</td>
        <td>{{profileuser.last_login}}</td>
      </tr>
      <tr>
        <td>{% trans "Is Staff" %}</td>
        <td>{% if profileuser.id_staff %}<i class="icon-ok-sign text-success" style="font-size:1.3em"></i>{% else %}<i class="icon-exclamation-sign text-danger" style="font-size:1.3em"></i>{% endif %}</td>
      </tr>
      <tr>
        <td>{% trans "Is Superuser" %}</td>
        <td>{% if profileuser.is_superuser %}<i class="icon-ok-sign text-success" style="font-size:1.3em"></i>{% else %}<i class="icon-exclamation-sign text-danger" style="font-size:1.3em"></i>{% endif %}</td>
      </tr>
    </table>
    <h3>{% trans "Permissions" %}</h3>
    <table class="table table-bordered">
      <tr>
        <th>{% trans "Permission" %}</th><th>{% trans "User" %}</th><th>{% trans "Group" %}</th>
      </tr>
      {% for permission in permission_list %}
        <tr>
          <td>{{permission.name}}</td>
          <td>{% if permission.codename in userperms %}<i class="icon-ok-sign text-success" style="font-size:1.3em"></i>{% else %}<i class="icon-exclamation-sign text-danger" style="font-size:1.3em"></i>{% endif %}</td>
          <td>{% if permission.codename in groupperms %}<i class="icon-ok-sign text-success" style="font-size:1.3em"></i>{% else %}<i class="icon-exclamation-sign text-danger" style="font-size:1.3em"></i>{% endif %}</td>
        </tr>
      {% endfor %}
    </table>
  </div>
</div>
  <div class="tab-pane" id="devices">
{% endif %}
    <div class="col-xs-12 col-md-12">
      <h4>{% trans "Owned devices" %}</h4>
    {% if devices %}
      <table id="devicetable" class="table table-bordered table-striped">
                          <thead>
                              <tr>
                                  <th scope="col">{% trans 'Device' %}</th>
                                  <th scope="col">{% trans 'Lendt since' %}</th>
                                  <th scope="col">{% trans 'Duedate' %}</th>
                                  <th scope="col">{% trans 'Room' %}</th>
                              </tr>
                          </thead>
                          <tbody>
                              {% for device in devices %}
                                  <tr>
                                      <td><a href="{% url 'device-detail' device.pk %}">{{device.name}}</a></td>
                                      <td>{{device.currentlending.lenddate}}</td>
                                      <td>{{device.currentlending.duedate}}{% if device.currentlending.duedate < weekago %}<span class="error-icon">!</span>
    {% elif device.currentlending.duedate < today %}<span class="warning-icon">!</span>
    {% endif %}</td>
                                      <td>{{device.room}}</td>
                                  </tr>
                              {% endfor %}
                          </tbody>
                      </table>
    {% else %}
      <h5>{% trans "User doesn't own any devices." %}</h5>
      {% endif %}
    </div>

{% if perms.users.read_user %}
  </div>
  <div class="tab-pane" id="edits">
<div class="col-xs-12 col-md-12">
  <h4>{% trans "Edits" %}</h4>
  {% if edits %}
  <table id="changehistory" class="table table-bordered table-striped" style="">
                      <thead>
                          <tr>
                              <th scope="col">{% trans 'Device' %}</th>
                              <th scope="col">{% trans 'Date/time' %}</th>
                              <th scope="col">{% trans 'Comment' %}</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for action in edits %}
                              <tr>
                                  <td><a href="{% url 'device-detail' action.object_id %}">{{action.field_dict.name}}</a></td>
                                  <td><a href="{% url 'device-history' action.object_id action.pk %}">{{action.revision.date_created}}</a></td>
                                  <td>{{action.revision.comment|linebreaksbr|default:""}}</td>
                              </tr>
                          {% endfor %}
                      </tbody>
                  </table>
  {% else %}
  <h5>{% trans "User hasn't edited anything." %}</h5>
  {% endif %}
</div>
  </div>
</div>
{% endif %}
</div>
{% endblock %}

{% block scriptend %}
var device_initialized = false;
{% if perms.users.read_user %}
var change_initialized = false;

$('a[data-toggle="tab"]').on('show.bs.tab', function (e) {
   e.target // activated tab
   e.relatedTarget // previous tab
   console.log($(e.target).data("tab"))
   if ($(e.target).data("tab") === "edits") {
      if (!change_initialized) {
        $('#changehistory').dataTable({});
        change_initialized = true;
      }
   }
});
{% endif %}
 if (!device_initialized) {
         $('#devicetable').dataTable({});
         device_initialized = true;
      }
{% endblock %}