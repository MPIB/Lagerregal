{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Main" %}{% endblock %}

{% block header %}
{% trans "Home" %}
{% endblock %}
{% block content %}
<div class="row">
  {% if user.is_staff %}
  <div class="small-5 columns dashboard dashboard-left">
    {% for widget in widgets_left %}
      {% with "snippets/widgets/"|add:widget.widgetname|add:".html" as template %}
      {% include template %}
      {% endwith %}
{% endfor %}
</div>

  <div class="small-7 columns dashboard dashboard-right">
    {% for widget in widgets_right %}
      {% with "snippets/widgets/"|add:widget.widgetname|add:".html" as template %}
      {% include template %}
      {% endwith %}
{% endfor %}
</div>

{% endif %}
</div>
{% endblock %}

{% block scriptend %}
$(function() {
    $( ".dashboard" ).sortable({
      connectWith: ".dashboard",
      placeholder: "dashboard-placeholder",
      distance: 15,
      receive: function(event, ui) {
      widgets = {};
      $(".dashboard-left").children('.widget').each(function(i) { 
          widgets[$(this).attr("id")] = {"index": $(this).index(this)+1, "column": "l"};
      });
      $(".dashboard-right").children('.widget').each(function(i) { 
          widgets[$(this).attr("id")] = {"index": $(this).index(this)+1, "column": "r"};
      });
        Dajaxice.main.move_widgets(Dajax.process, {'userwidgets':widgets})
    }
    });

    $('body').on('click', '.widget-header .minimize', function() {
        Dajaxice.main.toggle_minimized(Dajax.process,{'widgetname':$( this ).parents( ".widget:first" ).attr("id")})
    });
    
    $('body').on('click', '.widget-header .close', function() {
        Dajaxice.main.remove_widget(Dajax.process,{'widgetname':$( this ).parents( ".widget:first" ).attr("id")})
    });

    $(".addWidget").click(function() {
        Dajaxice.main.add_widget(Dajax.process,{'widgetname':$( this ).data("name")})
    });

    $(".widget-header .right").hide();
    
    $(".widget-header").hover(
      function () {
        $(this).children(".right").fadeIn();
      },
      function () {
        $(this).children(".right").fadeOut();
      }
    );

    $( ".columns" ).disableSelection();
  });
  {% endblock %}

  {% block htmlend %}
<a href="#" data-reveal-id="addWidgetModal" id="addWidgetButton"><i class="icon-plus"></i></a>

<div id="addWidgetModal" class="reveal-modal medium">
  <h2>Add a Widget</h2>
  <ul style="list-style-type: none;" id="widgetlist">
    {% for widget in widgets_list %}
    <li><a href="#" data-name="{{widget.0}}" class="addWidget">{{widget.1}}</a></li>
    {% endfor %}
  </ul>
  <a class="close-reveal-modal">&#215;</a>
</div>
  {% endblock %}